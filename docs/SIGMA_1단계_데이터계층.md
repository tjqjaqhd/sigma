# SIGMA 구현 명세 – 1단계: 데이터 계층 (확정 버전)

이 문서는 SIGMA 자동매매 시스템의 1단계 구현 작업인 **데이터 수집/전처리/저장 계층**의 목표, 구조, 함수 명세, 예외처리, 확장성 기준을 확정한다.

## 목표
- 바이낸스(현물, 1배 공매도, 차익거래) API를 통한 실시간/과거 데이터 수집
- GPT 전략생성에 필요한 정보(시장 데이터, 포트폴리오, 체결 등) 제공
- 데이터 정제/특징추출/저장 구조를 확장성 있게 설계
- 예외/에러 상황에 대한 명확한 처리 및 로깅

---

## 작업 체크리스트

### 1. 시장 데이터 수집 (`collector.py`)
- [x] 바이낸스 spot/margin/arbitrage 데이터 수집 함수 구현
- [x] 거래쌍, 가격, 거래량, 호가 등 주요 정보 포함
- [x] 확장: 다른 거래소/데이터 소스 함수 추가만으로 연동 가능

### 2. 데이터 전처리 (`preprocessor.py`)
- [x] clean_data(): 결측치/이상치 제거
- [x] normalize_data(): 단위 변환, 정규화
- [x] create_features(): 이동평균, 변동성 등 전략용 피처 생성
- [ ] 모든 함수는 입력/출력 예시와 함께 구현

### 3. 데이터 저장 (`db.py`)
- [ ] save_data(), load_data(): 메모리/SQLite/Redis 등 선택 저장
- [ ] 저장 실패/데이터 누락 등 예외 처리

### 4. 흐름 연동
- [x] run_data_pipeline(): 수집 → 정제 → 정규화 → 피처 생성 → 저장까지 한 번에 처리하는 파이프라인 함수 구현
- [x] collector, preprocessor, db 함수가 실제로 연동됨

### 5. 예외/에러 처리
- [x] 각 함수별 try-except, 에러 메시지/로깅
- [x] utils/error_handling.handle_error로 모든 에러 처리 일원화

### 6. 테스트/검증 기준
- [x] 각 함수별 샘플 데이터/실제 데이터로 최소 1회 테스트
- [x] 입력/출력 예시, 실패 케이스, 에러 로그 확인

---

## 구현/테스트 결과 요약

- **spot/margin/arbitrage 데이터 수집 함수**
  - 유동성 높은 심볼 자동 선택, 실시간 데이터 수집
  - 반환 예시:
    - spot: `[{'symbol': 'BTCUSDT', 'price': 104004.41, 'volume': 19293.93, 'bid': 104004.4, 'ask': 104004.41, 'timestamp': ...}, ...]`
    - margin: `[{'symbol': 'BTCUSDT', 'price': 104004.41, 'volume': 19293.93, 'bid': 104004.4, 'ask': 104004.41, 'timestamp': ..., 'type': 'margin'}, ...]`
    - arbitrage: `[{'symbol': 'BTCUSDT', 'spot_price': 104004.4, 'margin_price': 104004.41, 'spread': 0.01, ...}, ...]`
  - 실패/에러 케이스: 네트워크 오류, 심볼 미존재 등은 handle_error로 일원화 처리, 빈 리스트 반환
  - 테스트 결과: 실제 데이터 수집 및 주요 필드 검증, 모든 테스트 통과

## 구현 완료 기준
- src/data/ 하위의 수집, 정제, 저장 함수가 실제 바이낸스 데이터를 받아 처리 가능해야 함
- 시장 데이터 기준으로 최소 1회 시뮬레이션 루프가 가능해야 함
- 확장/변경 시 함수 추가만으로 구조가 유지되어야 함
- 예외 상황 발생 시 명확한 메시지/로깅이 남아야 함
- 모든 함수/로직은 문서와 1:1로 동기화되어야 함